{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://metaffi.com/schemas/idl-definition.json",
  "title": "MetaFFI IDL Definition",
  "description": "Schema for MetaFFI Interface Definition Language (IDL) JSON format",
  "type": "object",
  "properties": {
    "idl_source": {
      "type": "string",
      "description": "Filename without extension"
    },
    "idl_extension": {
      "type": "string",
      "description": "File extension (e.g., '.json', '.idl')"
    },
    "idl_filename_with_extension": {
      "type": "string",
      "description": "Full filename with extension"
    },
    "idl_full_path": {
      "type": "string",
      "description": "Absolute path to IDL file"
    },
    "metaffi_guest_lib": {
      "type": "string",
      "description": "Name of the guest library (auto-generated from idl_source)"
    },
    "target_language": {
      "type": "string",
      "description": "Target language for compilation (e.g., 'go', 'python', 'jvm')"
    },
    "modules": {
      "type": "array",
      "description": "Array of module definitions",
      "items": {
        "$ref": "#/$defs/module"
      }
    }
  },
  "required": [
    "idl_source",
    "idl_extension",
    "idl_filename_with_extension",
    "idl_full_path",
    "metaffi_guest_lib",
    "target_language",
    "modules"
  ],
  "$defs": {
    "metaffi_type": {
      "type": "string",
      "enum": [
        "float64",
        "float32",
        "int8",
        "int16",
        "int32",
        "int64",
        "uint8",
        "uint16",
        "uint32",
        "uint64",
        "bool",
        "char8",
        "char16",
        "char32",
        "string8",
        "string16",
        "string32",
        "handle",
        "array",
        "any",
        "size",
        "null",
        "float64_array",
        "float32_array",
        "int8_array",
        "int16_array",
        "int32_array",
        "int64_array",
        "uint8_array",
        "uint16_array",
        "uint32_array",
        "uint64_array",
        "bool_array",
        "char8_array",
        "char16_array",
        "char32_array",
        "string8_array",
        "string16_array",
        "string32_array",
        "handle_array",
        "any_array",
        "size_array"
      ]
    },
    "tags": {
      "type": "object",
      "description": "Key-value metadata map",
      "additionalProperties": {
        "type": "string"
      }
    },
    "entity_path": {
      "type": "object",
      "description": "Runtime routing information (e.g., module, package)",
      "additionalProperties": {
        "type": "string"
      }
    },
    "arg_definition": {
      "type": "object",
      "description": "Parameter or return value definition",
      "properties": {
        "name": {
          "type": "string",
          "description": "Argument name"
        },
        "type": {
          "$ref": "#/$defs/metaffi_type",
          "description": "MetaFFI type"
        },
        "type_alias": {
          "type": "string",
          "description": "Language-specific type alias (e.g., 'int', 'time.Duration')"
        },
        "comment": {
          "type": "string",
          "description": "Documentation comment"
        },
        "tags": {
          "$ref": "#/$defs/tags"
        },
        "dimensions": {
          "type": "integer",
          "description": "Array dimensions (0 = scalar, >0 = array)",
          "minimum": 0
        },
        "is_optional": {
          "type": "boolean",
          "description": "Whether parameter is optional",
          "default": false
        }
      },
      "required": [
        "name",
        "type",
        "type_alias",
        "comment",
        "tags",
        "dimensions"
      ]
    },
    "function_definition": {
      "type": "object",
      "description": "Function or method definition",
      "properties": {
        "name": {
          "type": "string",
          "description": "Function name"
        },
        "comment": {
          "type": "string",
          "description": "Documentation comment"
        },
        "tags": {
          "$ref": "#/$defs/tags"
        },
        "entity_path": {
          "$ref": "#/$defs/entity_path"
        },
        "parameters": {
          "type": "array",
          "description": "Function parameters",
          "items": {
            "$ref": "#/$defs/arg_definition"
          }
        },
        "return_values": {
          "type": "array",
          "description": "Function return values",
          "items": {
            "$ref": "#/$defs/arg_definition"
          }
        },
        "overload_index": {
          "type": "integer",
          "description": "Overload index (0 = not overloaded, 1+ = overload number)",
          "default": 0
        }
      },
      "required": [
        "name",
        "comment",
        "tags",
        "entity_path",
        "parameters",
        "return_values"
      ]
    },
    "method_definition": {
      "type": "object",
      "description": "Class method definition",
      "allOf": [
        {
          "$ref": "#/$defs/function_definition"
        },
        {
          "properties": {
            "instance_required": {
              "type": "boolean",
              "description": "Whether method requires instance (false for static methods)",
              "default": true
            }
          },
          "required": [
            "instance_required"
          ]
        }
      ]
    },
    "constructor_definition": {
      "type": "object",
      "description": "Class constructor definition",
      "allOf": [
        {
          "$ref": "#/$defs/function_definition"
        }
      ]
    },
    "release_definition": {
      "type": "object",
      "description": "Class destructor/releaser definition",
      "allOf": [
        {
          "$ref": "#/$defs/method_definition"
        }
      ]
    },
    "field_definition": {
      "type": "object",
      "description": "Class field/property definition",
      "allOf": [
        {
          "$ref": "#/$defs/arg_definition"
        },
        {
          "properties": {
            "getter": {
              "oneOf": [
                {
                  "$ref": "#/$defs/method_definition"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Optional getter method"
            },
            "setter": {
              "oneOf": [
                {
                  "$ref": "#/$defs/method_definition"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Optional setter method"
            }
          }
        }
      ]
    },
    "global_definition": {
      "type": "object",
      "description": "Global variable definition",
      "allOf": [
        {
          "$ref": "#/$defs/arg_definition"
        },
        {
          "properties": {
            "getter": {
              "oneOf": [
                {
                  "$ref": "#/$defs/function_definition"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Optional getter function"
            },
            "setter": {
              "oneOf": [
                {
                  "$ref": "#/$defs/function_definition"
                },
                {
                  "type": "null"
                }
              ],
              "description": "Optional setter function"
            }
          }
        }
      ]
    },
    "class_definition": {
      "type": "object",
      "description": "Class/struct definition",
      "properties": {
        "name": {
          "type": "string",
          "description": "Class name"
        },
        "comment": {
          "type": "string",
          "description": "Documentation comment"
        },
        "tags": {
          "$ref": "#/$defs/tags"
        },
        "entity_path": {
          "$ref": "#/$defs/entity_path"
        },
        "constructors": {
          "type": "array",
          "description": "Class constructors",
          "items": {
            "$ref": "#/$defs/constructor_definition"
          }
        },
        "release": {
          "oneOf": [
            {
              "$ref": "#/$defs/release_definition"
            },
            {
              "type": "null"
            }
          ],
          "description": "Class destructor/releaser"
        },
        "methods": {
          "type": "array",
          "description": "Class methods",
          "items": {
            "$ref": "#/$defs/method_definition"
          }
        },
        "fields": {
          "type": "array",
          "description": "Class fields/properties",
          "items": {
            "$ref": "#/$defs/field_definition"
          }
        }
      },
      "required": [
        "name",
        "comment",
        "tags",
        "constructors",
        "release",
        "methods",
        "fields"
      ]
    },
    "module": {
      "type": "object",
      "description": "Module definition containing functions, classes, and globals",
      "properties": {
        "name": {
          "type": "string",
          "description": "Module name"
        },
        "comment": {
          "type": "string",
          "description": "Documentation comment"
        },
        "tags": {
          "$ref": "#/$defs/tags"
        },
        "functions": {
          "type": "array",
          "description": "Module-level functions",
          "items": {
            "$ref": "#/$defs/function_definition"
          }
        },
        "classes": {
          "type": "array",
          "description": "Module classes",
          "items": {
            "$ref": "#/$defs/class_definition"
          }
        },
        "globals": {
          "type": "array",
          "description": "Module-level global variables",
          "items": {
            "$ref": "#/$defs/global_definition"
          }
        },
        "external_resources": {
          "type": "array",
          "description": "External dependencies (e.g., library names, file paths)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "name",
        "comment",
        "tags",
        "functions",
        "classes",
        "globals",
        "external_resources"
      ]
    }
  }
}
